\chapter{Deciding Fixed Round Simulation}
\label{chap:deciding_fixed_round_sim}

In this section we show decidability of fixed round simulation (and, by \cref{lem:reduce_equiv_to_simulation}, fixed round equivalence). The tools we develop will be used in \cref{sec:deciding_existential_round_sim} to handle the existential variant.

Let $\sI$ and $\sO$ be input and output alphabets. Consider two $\sI/\sO$ transducers $\cT_1$ and $\cT_2$, and let $\fL\subseteq \sI^*$ and $k>0$.
In order to decide whether $\cT_1\prec_{k,\fL} \cT_2$, we proceed as follows. First, we cast the problem to a problem about deterministic automata. Then, we translate $k$-rounds into letters, by working over the alphabets $\sI^k$ and $\sO^k$. We construct an \NFA, dubbed the \emph{permutation closure}, for each transducer $\cT$, that captures the behaviour of $\cT$ on words and their permutations. Intuitively, the \NFA takes as input a word $(x,y)\in (\sI^{k}\times \sO^k)^*$, guesses a round-equivalent word $x'\req x$, and verifies that $\cT(x')\req \cT(x)$. We then show that round-simulation amounts to deciding the containment of these \NFAs.
We now turn to give the details of the construction. 

\subparagraph*{The Trace \bf DFA}
Consider a transducer $\cT=\tup{\sI,\sO,Q,q_0,\delta,\lab}$, we define its \emph{trace \DFA} $\tr(\cT)=\tup{\sI\times\sO,Q\cup\{q_{\bot}\},q_0,\eta,Q}$ where for $q\in Q$ and $(\sigma,\sigma')\in \sI\times \sO$ we define $\eta(q,(\sigma,\sigma'))=\delta(q,\sigma)$ if $\cT^{q}(\sigma)=\sigma'$ and $\eta(q,(\sigma,\sigma'))=q_{\bot}$ otherwise.
$q_\bot$ is a rejecting sink. 

$\tr(\cT)$ captures the behaviour of $\cT$ in that $L(\tr(\cT))=\{(x,y)\in (\sI\times \sO)^*\ST \cT(x)=y\}$. 

\subparagraph*{The Permutation-Closure \bf NFA}
Consider an \NFA $\cN=\tup{\sI\times\sO,S,s_0,\eta,F}$, and let $k>0$. 
We obtain from $\cN$ an \NFA $\perm_k(\cN)=\tup{\sI^k \times \sO^k,S, s_0, \mu, F}$
where the alphabet is $\sI^k\times \sO^k$, and the transition function $\mu$ is defined as follows. For a letter $(\alpha,\beta)\in \sI^k \times \sO^k$ and a state $s\in S$, we think of $(\alpha,\beta)$ as a word in $(\sI\times \sO)^*$. Then we have
\begin{equation}
	\label{eq:perm_transition}
	\mu(s,(\alpha,\beta))=\bigcup\{\eta^*(s,(\alpha',\beta')) \ST \fP(\alpha')=\fP(\alpha) \wedge \fP(\beta)=\fP(\beta')\}.
\end{equation}

That is, upon reading $(\alpha,\beta)$, $\perm_k(\cN)$ can move to any state $s'$ that is reachable in $\cN$ from $s$
by reading a permutation of $\alpha,\beta$ (denoted $\alpha',\beta'$).
Recall that for two words $x,x'$ we have that $x\req[k]x'$ if for every two corresponding $k$-rounds $\alpha,\alpha'$ in $x$ and $x'$ we have $\fP(\alpha)=\fP(\alpha')$. 
Thus, we have the following.
\begin{observation}
	\label{obs:perm_closure_language}
	$L(\perm_k(\cN))=\{(x,y)\in \sI^*\times \sO^* \ST \exists x'\req[k] x, y'\req[k] y, (x',y')\in L(\cN) \wedge\ |x|=|y|=kR \text{ for some }R\in \bbN\}$
	\end{observation}
Since the transition function of $\perm_k(\cN)$ is only defined using permutations of its input letters, we have the following property, which we refer to as \emph{permutation invariance}:
\begin{observation}[Permutation Invariance]
	\label{obs:perm_invariance}
	For every state $s\in S$ and letters $(\alpha,\beta), (\alpha',\beta')\in \sI^k \times \sO^k$, if $\fP(\alpha)=\fP(\alpha')$ and $\fP(\beta)=\fP(\beta')$ then $\mu(s,(\alpha,\beta))=\mu(s,(\alpha',\beta'))$.
\end{observation}

Given a transducer $\cT$, we apply the permutation closure to the trace $\DFA$ of $\cT$. In order to account for $\fL\subseteq \sI^*$, we identify it with $\fL\subseteq \sI^*\times \sO^*$ by simply ignoring the $\sO$ component. We remind that $\fL$ denotes both a language and a corresponding \DFA or \NFA.
\begin{lemma}
	\label{lem:permutation_closure_construction}
	Consider transducers $\cT_1,\cT_2$, an \NFA $\fL$ and $k>0$. Let $\cA_1^k=\perm_k(\tr(\cT_1)\cap \fL)$ (where the intersection is obtained by the product \NFA) and $\cA_2^k=\perm_k(\tr(\cT_2))$, then
	\begin{flalign*}
	L(\cA_1^k)&=\{(x,y)\in \sI^*\times \sO^* \ST \exists x'\req[k] x,\ \cT_1(x')\req[k] y\ \wedge\ |x|=|y|=kR \text{ where }R\in \bbN \wedge x'\in \fL\}.&\\
	L(\cA_2^k)&=\{(x,y)\in \sI^*\times \sO^* \ST \exists x'\req[k] x,\ \cT_2(x')\req[k] y\ \wedge\ |x|=|y|=kR \text{ where }R\in \bbN\}.&
	\end{flalign*}
\end{lemma}
\begin{proof}
	Recall that $\tr(\cT)$ accepts a word $(x',y')$ iff $\cT(x')=y'$. The claim then follows from \cref{obs:perm_closure_language}, by replacing the expression $y\req y' \wedge (x',y')\in L(\tr(\cT))$ with the equivalent expression $\cT(x')\req[k] y$.
\end{proof}

We now reduce round simulation to the containment of permutation-closure \NFAs.

\begin{lemma}
\label{lem:round_equivalence_iff_perm_containment}
	Consider transducers $\cT_1,\cT_2$, an \NFA $\fL$ and $k>0$. Let $\cA_1^k=\perm_k(\tr(\cT_1)\cap\fL)$ and $\cA_2^k=\perm_k(\tr(\cT_2))$,
	then, $\cT_1\prec_{k,\fL} \cT_2$ iff $L(\cA^k_1)\subseteq L(\cA^k_2)$.
\end{lemma}
\begin{proof}
	For the first direction, assume $\cT_1\prec_{k,\fL} \cT_2$, and let $(x,y)\in L(\cA^k_1)$. By~\cref{lem:permutation_closure_construction}, $x$ and $y$ are $k$-round words, and there exists a word $x'\in \fL$ such that $x\req x'$ and $\cT_1(x')\req y$. Since $\cT_1\prec_{k,\fL} \cT_2$, then applying the definition on $x'$ yields that there exists a $k$-round word $x''$ such that $x'\req x''$ and such that $\cT_1(x')\req \cT_2(x'')$. Since $\req$ is an equivalence relation, it follows that $x\req x''$ and $\cT_2(x'')\req y$, so again by \cref{lem:permutation_closure_construction} we have $(x,y)\in L(\cA^k_2)$.
	
	Conversely, assume $L(\cA^k_1)\subseteq L(\cA^k_2)$, we wish to prove that for every $k$-round word $x\in \fL$ there exists a word $x'$ such that $x\req x'$ and $\cT_1(x)\req \cT_2(x')$. Let $x\in \fL$ be a $k$-round word, and let $y=\cT_1(x)$, then clearly $(x,y)\in L(\cA^k_1)\subseteq L(\cA^k_2)$ (since $x\req x$, $\cT_1(x)=y\req y$ and $x\in \fL$). By \cref{lem:permutation_closure_construction}, there exists $x'$ such that $x\req x'$ and $\cT_2(x')\req y=\cT_1(x)$, so $\cT_2(x')\req \cT_1(x)$, thus concluding the proof.
\end{proof}

\begin{remark}
\label{rmk:det_A1}
The proof of \cref{lem:round_equivalence_iff_perm_containment} can be simplified by using instead of $\cA^k_1$, the augmentation of $\tr(\cT_1)\cap \fL$ to $k$-round words. However, such a \DFA is not permutation invariant, which is key to our solution for existential round simulation. Since this simplification does not reduce the overall complexity, we use a uniform setting for both solutions.
\end{remark}

\cref{lem:round_equivalence_iff_perm_containment} shows that deciding fixed round equivalence amounts to deciding containment of \NFAs. By analyzing the size of the \NFAs, we obtain the following.
\begin{theorem}
	\label{thm:fixed_re_PSPACE}
	Given transducers $\cT_1,\cT_2$, an \NFA $\fL$, and $k>0$ in unary, the problem of deciding whether $\cT_1\prec_{k,\fL}\cT_2$ is in \PSPACE.
\end{theorem}
\begin{proof}
	Let $\cA_1^k=\perm_k(\tr(\cT_1)\cap \fL)$ and $\cA_2^k=\perm_k(\tr(\cT_2))$. By \cref{lem:round_equivalence_iff_perm_containment}, deciding whether $\cT_1\prec_{k,\fL} \cT_2$ amounts to deciding whether $L(\cA^k_1)\subseteq L(\cA^k_2)$. Looking at the dual problem, recall that for two \NFAs $\cN_1, \cN_2$ we have that $L(\cN_1)\not\subseteq L(\cN_2)$ iff 
	there exists $w\in L(\cN_2)\setminus L(\cN_1)$ with $|w|\le |\cN_1|\cdot 2^{|\cN_2|}$ (this follows immediately by bounding the size of an \NFA for $L(\cN_1)\cap \overline{L(\cN_2)}$). Thus, we can decide whether $L(\cA^k_1)\subseteq L(\cA^k_2)$ by guessing a word $w$ over $\sI^k\times \sO^k$ of single-exponential length (in the size of $\cA^k_1$ and $\cA^k_2$), and verifying that it is accepted by $\cA^k_1$ and not by $\cA^k_2$. 
	
	Observe that to this end, we do not explicitly construct $\cA^k_1$ nor $\cA^k_2$, as their alphabet size is exponential. Rather, we evaluate them on each letter of $w$ based on their construction from $\cT$. At each step we keep track of a counter for the length of $w$, a state of $\cA^k_1$, and a set of states of $\cA^k_2$. Since the number of states in $\cA^k_1$ and $\cA^k_2$ is the same as that of $\cT_1$ and $\cT_2$, this requires polynomial space.
	
	By Savitch's theorem we have that $\mathsf{coNPSPACE}=\PSPACE$, and the proof is concluded.
\end{proof}

We now give a \PSPACE-hardness lower bound, thus concluding the problem is \PSPACE-complete. By~\cref{lem:reduce_equiv_to_simulation}, we give a stronger lower bound already for round-equivalence.\footnote{The reduction in \cref{lem:reduce_equiv_to_simulation} is a Turing reduction. Nonetheless, our \PSPACE-hardness proof actually explicitly shows the hardness of both simulation and equivalence.}
\begin{theorem}
\label{thm:equivalence_PSPACE-H}
The problem of deciding, given transducers $\cT_1,\cT_2$, whether $\cT_1\equiv_{k,\fL} \cT_2$, is \PSPACE-hard, even for $k=2$ and for a fixed $\fL$ (given as a 4-state \DFA).
\end{theorem}
\begin{proof}[Proof sketch]
We show a reduction from the universality problem for $\NFAs$ over alphabet $\{0,1\}$ where all states are accepting and the degree of nondeterminism is at most 2, to round-equivalence with $k=2$ and with $\fL$ given as a \DFA of constant size. See the full version for a proof of  \PSPACE-hardness of the former problem, and for the full reduction.

Consider an \NFA $\cN=\tup{Q,\{0,1\},\delta,q_0,Q}$ where $|\delta(q,\sigma)|\le 2$ for every $q\in Q$ and $\sigma\in \{0,1\}$.

We construct two transducers $\cT_1$ and $\cT_2$ over input and output alphabets $\sI=\{a,b,c,d\}$ and $\sO=\{\top,\bot\}$ and $\fL\subseteq \sI^*$, such that $L(\cN)=\{0,1\}^*$ iff $\cT_1\equiv_{2,\fL}\cT_2$. 

Set $\fL=(ab+cd)^*$.
Intuitively, our reduction encodes $\{0,1\}$ over $\{a,b,c,d\}$ by identifying $0$ with $ab$ and with $ba$, and $1$ with $cd$ and with $dc$. 
Then, $\cT_1$ (\cref{fig:PSPACE_reduction_T1}) keeps outputting $\top$ for all inputs in $\fL$, thus mimicking a universal language in $\{0,1\}^*$. We then construct $\cT_2$ so that every nondeterministic transition of $\cN$ on e.g., $0$ is replaced by two deterministic branches on $ab$ and on $ba$ (see~\cref{fig:PSPACE_reduction_T2}). Hence, when we are allowed to permute $ab$ and $ba$ by round equivalence, we capture the nondeterminism of $\cN$. The outputs in $\cT_2$ are all $\top$, except a sink state $q_\bot$ labelled $\bot$, which is reached upon any undefined transition (including transitions from states of $\cN$ that do not have an outgoing $0$ or $1$ transition).

\begin{figure}
\begin{minipage}{.30\linewidth}
	\begin{tikzpicture}[shorten >=1pt,node distance=1cm and 1.5cm,initial distance=0.2cm,on grid,auto]
	\tikzstyle{smallnode}=[circle, inner sep=0mm, outer sep=0mm, minimum size=5mm, draw=black];
	\clip (-2,0.9) rectangle (2.4, -1.3);
		\node[smallnode, initial text={}] (q_0) [initial above] {$\color{red} \top$}; 
		\node[smallnode] (q_1) [right=of q_0] {$\color{red} \top$}; 
		\node[smallnode] (q_2) [left=of q_0] {$\color{red} \top$};
		\node[smallnode] (q_3) [below=of q_0] {$\color{red} \bot$};
		
		\path[->] 
		(q_0)
		 edge [bend right, swap, pos=0.6] node {$a$} (q_1)
		 edge [bend left] node {$c$} (q_2)
		 edge [pos=0.7] node {$b,d$} (q_3)
		(q_1) 
		 edge [bend right, swap] node {$b$} (q_0)
		 edge [out=-90, in=0] node[pos=0.8,yshift=0.2cm] {$a,c,d$} (q_3)
		(q_2)
	     edge [bend left] node {$d$} (q_0)
		 edge [out=-90, in=180, swap] node[pos=0.8,yshift=0.2cm] {$a,b,c$} (q_3);
	\end{tikzpicture}
 	\caption{The transducer $\cT_1$ in the proof of \cref{thm:equivalence_PSPACE-H}.}
 	\label{fig:PSPACE_reduction_T1}
 \end{minipage}%
 \hfill%
 \begin{minipage}{.65\linewidth}
	\begin{tikzpicture}[shorten >=1pt,node distance=1cm and 1.2cm,on grid,auto]
		\tikzstyle{state}=[circle, inner sep=0mm, outer sep=0mm, minimum size=6mm, draw=black];
		\node[state] (q_0) {$q$}; 
		\node[state] (q_1) [above right=of q_0] {$q^{0,0}$}; 
		\node[state] (q_2) [right=of q_0] {$q^{0,1}$}; 
		\node[state] (q_3) [above left=of q_0] {$q^{1,0}$}; 
		\node[state] (q_4) [left=of q_0] {$q^{1,1}$}; 
		
		\path[->] 
		(q_0)
		 edge node [pos=0.6] {$0$} (q_1)
		 edge node [pos=0.6] {$0$} (q_2)
		 edge node [pos=0.6, swap] {$1$} (q_3)
		 edge node [pos=0.6, swap] {$1$} (q_4);
	\end{tikzpicture}%
	\hspace{0.5cm}%
	\begin{tikzpicture}[shorten >=1pt,node distance=1cm and 1.2cm,on grid,auto]
	    \tikzstyle{state}=[circle, inner sep=0mm, outer sep=0mm, minimum size=6mm, draw=black];
		\node[state] (q_0) {$q$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q_a$}] (q_1) [above right=of q_0] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q_b$}] (q_2) [right=of q_0] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q_c$}] (q_3) [above left=of q_0] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q_d$}] (q_4) [left=of q_0] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q^{0,0}$}] (q_1b)[right=of q_1] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q^{0,1}$}] (q_2b)[right=of q_2] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q^{1,0}$}] (q_3b)[left=of q_3] {$\color{red} \top$}; 
		\node[state, label={[font=\footnotesize,label distance=-.1cm]above:$q^{1,1}$}] (q_4b)[left=of q_4] {$\color{red} \top$}; 
		
		\path[->] 
		(q_0)
		 edge node [pos=0.6] {$a$} (q_1)
		 edge node [pos=0.6] {$b$} (q_2)
		 edge node [pos=0.6, swap] {$c$} (q_3)
		 edge node [pos=0.6, swap] {$d$} (q_4)
		(q_1) edge node [pos=0.6] {$b$} (q_1b)
		(q_2) edge node [pos=0.6] {$a$} (q_2b)
		(q_3) edge node [pos=0.6, swap] {$d$} (q_3b)
		(q_4) edge node [pos=0.6, swap] {$c$} (q_4b);
	\end{tikzpicture}
 	\caption{Every state and its 4 transitions in $\cN$ (left) turn into 8 transitions in $\cT_2$ (right). All transitions not drawn in the right figure lead to $q_\bot$, a sink state labelled $\color{red}\bot$.}
 	\label{fig:PSPACE_reduction_T2}
 \end{minipage}
\end{figure}

We show that $L(\cN)=\{0,1\}^*$ iff $\cT_1\equiv_{2,\fL}\cT_2$, by showing that $\cT_2\prec_{2,\fL}\cT_1$ always holds, and that for the converse, namely $\cT_1\prec_{2,\fL}\cT_2$, permuting an input word $w\in \fL$ essentially amounts to choosing an accepting run of $\cN$ on the corresponding word in $\{0,1\}^*$.
\end{proof}

\begin{corollary}
\label{cor:PSPACE-C}
Given transducers $\cT_1,\cT_2$, an \NFA $\fL$, and $k>0$ in unary, the problem of deciding whether $\cT_1\prec_{k,\fL}\cT_2$ is \PSPACE-complete.
\end{corollary}
