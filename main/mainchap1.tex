\chapter{Round Simulation and Round Equivalence}
\label{chap:round_equivalence}

\section{Introduction}

You might have a per-chapter mini-intro, possibly tying in to the relevant part of the general intro.

\section{A section}

\lipsum[1]

Let's cite a source: \cite{Yao1977}. And now,  let's introduce a (numbered) equation. It will use \gls{symb:c}, which is one of the entries in the ``\nameref{chap:notation-and-abbreviations}'' list. The equation will be in ``display math'' mode, using the \texttt{align} environment.

\begin{align}
\label{eq:emc2}
e &= mc^2
\end{align}
\begin{notes}
\item	Are you seeing a problem with the equation numbering? In some TeX processors and on some platforms, there may be a layout error, so that instead of ``(3.1)'' you get ``)3.1)'' or some other flipping of directions. Specifically, \url{http://overleaf.com} suffers from this problem (at least until 2020). Please make sure and use an appropriate TeX distribution that's up-to-date. Specifically, recent TeXLive versions work fine. On Overleaf, you can switch TeXLive versions using the main menu.
\end{notes}

In \autoref{sec:thm-like} below, we will state some theorems.

\section{Results... and theorem-like environments}
\label{sec:thm-like}

What's so special about the theorem-like environments used here? There are several packages which offer the capability of defining these, mainly \texttt{amsthm}, \texttt{ntheorem} and also \texttt{thmtools}. (The last is probably also the most feature-full and versatile, but I'm not familiar with it and the first two are the popular ones.) Many people writing a Technion thesis start with \texttt{amsthm}, only to find out it has conflicts with Hebrew... also, there's the issue of aliasing (same counter for lemmata and theorems, but having \texttt{{\textbackslash}autoref} and similar commands know what they're referencing.) This is all neatly resolved in \texttt{iitthesis-extra.sty} with \texttt{amsthm}-like-looking environments actually done with nthrerom.

\begin{theorem}
\label{thm:first}
This is the first numbered theorem in this thesis.
\end{theorem}

And we can refer to it using \texttt{ref}: \ref{thm:first} and get the number, or use hypertex's \texttt{autoref}: \autoref{thm:first}.

\begin{corollary}
\label{cor:first}
There are no lemmata appearing before theorems in this thesis.
\end{corollary}

\begin{theorem*}
This is the second theorem, unnumbered.
\end{theorem*}

\begin{theorem*}[\protect{\cite[Theorem 2]{Knuth1973}}]
This is an unnumbered theorem cited from elsewhere. \qbfox{1} ... and it was Knuth's dog.
\end{theorem*}

\begin{note}
This is a note environment.  \qbfox{2}
\end{note}

\begin{definition}
\label{def:first}
An \emph{quick brown fox} is a fox which is not only fast and agile but is also characterized by brown fur. Such foxes sometimes tend to jump over lazy dogs.
\end{definition}

\begin{lemma}
\label{lem:first}
This is a lemma. \qbfox{2}
\end{lemma}

Even though \autoref{lem:first} and \autoref{def:first} share the ``same'' counter, when referring to them, their names are used automagically.

Here's a proof of the lemma:
\begin{proof}%[lem:natural:blowups-preserve-distance-on-average]
\lipsum[2]
	It's common to conclude proofs with a QED symbol --- typically a full or an empty black square. To do so, append the command \verb|\qed| after the last sentence of your proof; or, alternatively, you can use some \LaTeX{} trickery in the definition of the proof environment to ensure this symbol is appended to all proofs. This is done in the \texttt{misc/iitthesis-extra.sty} style file, which is used by this template. You will see the result as a black square at the end of this proof environment.
\end{proof}

Now here's a proof of \autoref{thm:first} using the \verb|proofof| environment.
\begin{proofof}[thm:first]
\lipsum[3]
\end{proofof}

\begin{note}There may currently be a problem getting the QED symbol (\verb|\qed|) to appear if your proof environment ends with certain display-mode-math environments, such as \verb|align*|.
\end{note}

\begin{proposition}
\label{prop:first}
This is a proposition environment. \qbfox{2}
\end{proposition}

\begin{observation}
\label{obs:first}
The moon revolves around the earth.
\end{observation}

There are several other theorem-like environments, of various kinds, defined in the file \texttt{misc/iitthesis-extra.sty}; and naturally you can add or modify these as you see fit.

\subsection{A subsection}

We've started a subsection. Here is a reference to another chapter: \autoref{chap:prelims} --- realized with the \verb|\autoref| command. If you've used \texttt{iitthesis-extra.sty}, it should ensure the environment name produced by \verb|\autoref| is capitalized (``Chapter'' rather than ``chapter'').

\begin{algorithm}
\caption{A nice algorithm}
\label{alg:first}
\begin{algorithmic}[1]
\FOR{$n$ times}
  \STATE{Do something.}
  \STATE{Do something else.}
\ENDFOR
\STATE{And do one last thing.}
\end{algorithmic}
\end{algorithm}

It is recommended to use \texttt{algorithmicx} over \texttt{algorithmic} for algorithms, like in \autoref{alg:first}, as it has less conflicts with Hebrew babel (regardless of whether you have Hebrew in your algorithms or not). Also, \texttt{iitthesis-extra.sty} provides it with a necessary workaround.

\subsection{A second subsection}

In this subsection we'll have a figure. Remember that the {\LaTeX} compiler can place figures a little before or after where they are defined, according to the placement option choice and depending on the flow of the rest of the text.

\begin{figure}[htb]
  \centering
  \ifpdf
    \includegraphics{graphics/mygraphic1.pdf}
  \else
    \includegraphics{graphics/mygraphic1-for-ps.eps}
  \fi
  \caption{Two circles and a wavy line.}
\end{figure}

Let's also have, to conclude this subsection, another use of a term from ``\nameref{chap:notation-and-abbreviations}'', which we first used earlier (in \autoref{chap:prelims}). Here it is: \gls{DIY}. This will ensure it appears on multiple pages; but - its entry will only mention the first appearance, not this one.

\label{sec:round-equivalence}
Consider two $k$-round words $x,y\in \Sigma^{kR}$ with the same number of rounds $R$, and denote their rounds by $x=\alpha_0\cdots \alpha_{R-1}$ and $y=\beta_0\cdots \beta_{R-1}$. We say that $x$ and $y$ are \emph{$k$-round equivalent}, denoted $x\req[k] y$ (or $x\req y$, when $k$ is clear from context)\footnote{Conveniently, our symbol for round equivalence is a rounded equivalence.}, if for every $0\le r<R$ we have that $\fP(\alpha_r)=\fP(\beta_r)$. That is, $x\req y$ iff the $r$-th round of $y$ is a permutation of the $r$-th round of $x$, for every $r$. Clearly $\req$ is indeed an equivalence relation.

\begin{example}[Round-equivalence for words]
\label{example:word-req}
Consider the words $x=abaabbabbbaa$ and $y=baabbaabbaba$ over the alphabet $\Sigma=\{a,b\}$. Looking at the words as $3$-round words, one can see in \autoref{tab:word-req-3} that the 3-rounds in $y$ are all permutations of those in $x$, which gives $x\req[3] y$. However, looking at $x,y$ as $4$-round words, the number of occurrences of $b$ already in the first 4-round of $x$ and of $y$ is different, so $x\not\req[4] y$, as illustrated in \autoref{tab:word-req-4}.\qed
\begin{table}[!htb]
\begin{minipage}{.5\linewidth}
    \centering
    \begin{tabular}{c||c|c|c|c}
        $x$ & aba & abb & abb & baa \\
        \hline
        $y$ & baa & bba & abb & aba \\
    \end{tabular}
    \caption{$x$ and $y$ are $3$-round equivalent}
    \label{tab:word-req-3}
\end{minipage}%
\begin{minipage}{.5\linewidth}
    \centering
    \begin{tabular}{c||c|c|c}
        $x$ & \emph{abaa} & bbab & bbaa \\
        \hline
        $y$ & \emph{baab} & baab & baba \\
    \end{tabular}
    \caption{$x$ and $y$ are not $4$-round equivalent}
    \label{tab:word-req-4}
\end{minipage}
\end{table}
\end{example}

Let $\sI$ and $\sO$ be input and output alphabets, let $\fL\subseteq \sI^*$ be a regular language, and let $k>0$. Consider two $\sI/\sO$ transducers $\cT_1$ and $\cT_2$. We say that \emph{$\cT_2$ $k$-round simulates $\cT_1$ restricted to $\fL$}, denoted $\cT_1\prec_{k,\fL} \cT_2$, if for every $k$-round word $x\in \fL$ there exists a $k$-round word $x'\in \sI^*$ such that $x\req[k] x'$ and $\cT_1(x)\req[k] \cT_2(x')$. 

Intuitively, $\cT_1\prec_{k,\fL} \cT_2$ if for every input word $x\in \fL$, we can permute each $k$-round of $x$ to obtain a new word $x'$, such that the $k$-rounds of the outputs of $\cT_1$ on $x$ and of $\cT_2$ on $x'$ are permutations of each other. 
Note that the definition is not symmetric: the input $x$ for $\cT_1$ is universally quantified, while $x'$ is chosen according to $x$. We illustrate this in \autoref{example:def-asymmetric}.

If $\cT_1\prec_{k,\fL} \cT_2$ and $\cT_2\prec_{k,\fL} \cT_1$ we say that $\cT_1$ and $\cT_2$ are \emph{$k$-round equivalent restricted to $\fL$}, denoted $\cT_1\equiv_{k,\fL} \cT_2$. 
In the special case where $\fL=\sI^*$ (i.e., when we require the simulation to hold for every input), we omit it from the subscript and write e.g., $\cT_1\prec_k \cT_2$.

\begin{example}[Round Robin]
\label{example:transducer-req}
We consider a simple version of the Round Robin scheduler for three processes $\cP=\{0,1,2\}$. In each time step, the scheduler outputs either a singleton set containing the ID of the process whose request is granted, or an empty set if the process whose turn it is did not make a request. 
Depending on the ID $i\in \{0,1,2\}$ of the first process, we model the scheduler as a $2^{\cP}/2^{\cP}$ transducer $\cT_i = \tup{2^\cP, 2^\cP, Q, q_{(i-1)\%3}, \delta, \lab}$ depicted in \autoref{fig:RR}, where \% is the $\bmod$ operator, $Q=\left\{q_0,q_1,q_2,q'_0,q'_1,q'_2\right\}$, $\delta(q_i, \sigma)=q_{(i+1)\%3}$ if $i+1\in\sigma$ and $\delta(q_i,\sigma)=q'_{(i+1)\%3}$ otherwise, $\lab(q_i)=\{i\}$ and $\lab(q'_i)=\emptyset$.
\begin{figure}[ht]
	\centering
	\small
	\begin{tikzpicture}[shorten >=1pt,node distance=1.5cm and 4cm,on grid,auto]
	\tikzset{state/.style={draw,ellipse,minimum size=0pt}};
		\clip (-1.5,1.5) rectangle (9, -3);
		\node[state] (q_0) {$q_0/{\color{red}0}$}; 
		\node[state] (q_1) [right=of q_0] {$q_1/{\color{red}1}$}; 
		\node[state] (q_2) [right=of q_1] {$q_2/{\color{red}2}$}; 
		\node[state] (q'_0) [below=of q_0] {$q'_0/{\color{red}\emptyset}$}; 
		\node[state] (q'_1) [below=of q_1] {$q'_1/{\color{red}\emptyset}$}; 
		\node[state] (q'_2) [below=of q_2] {$q'_2/{\color{red}\emptyset}$}; 
		\path[->] 
		(q_0)  edge node {$1$} (q_1)
		edge [sloped] node[pos=0.7] {$\lnot 1$} (q'_1)
		(q_1)  edge node {$2$} (q_2)
		edge [sloped] node [pos=0.7] {$\lnot 2$} (q'_2)
		(q_2)  edge [bend right=15, above] node {$0$} (q_0)
		edge [sloped, out=160, in=130, looseness=1.5, above] node  [below,pos=0.5] {$\lnot 0$} (q'_0)
		(q'_0) edge [sloped] node [pos=0.7] {$1$} (q_1)
		edge node {$\lnot 1$} (q'_1)
		(q'_1) edge [sloped] node [pos=0.7] {$2$} (q_2)
		edge node {$\lnot 2$} (q'_2)
		(q'_2) edge [sloped, out=200, in=230, looseness=1.5, below] node [above,pos=0.5] {$0$} (q_0)
		edge [bend left=15] node {$\lnot 0$} (q'_0)
		(q_2); 
	\end{tikzpicture}
	\caption{The transducer $\cT_i$ for Round Robin, initial state omitted. The input letters $\sigma$ and $\lnot\sigma$ mean all input letters from $2^\cP$ that, respectively, contain or do not contain $\sigma$. The labels are written in red on the states, singleton brackets omitted (e.g., ${\color{red} 1}$ means $\{1\}$).}
	\label{fig:RR}
\end{figure}

Technically, the initial state changes the behaviour of $\cT_i$ significantly (e.g. $\cT_0(\{0\}\{2\}\{1\})=\{0\}\emptyset\emptyset$ whereas $\cT_1(\{0\}\{2\}\{1\})=\emptyset\{2\}\emptyset$). Conceptually, however, changing the initial state does not alter the behaviour, as long as the requests are permuted accordingly. This is captured by round equivalence, as follows.

We argue that, if we allow reordering of the input letters, then the set of processes whose requests are granted in each round is independent of the start state. This is equivalent to saying $\cT_0 \equiv_k \cT_j$ for $j\in \{1,2\}$, which indeed holds: if $j=1$ then we permute all rounds of the form $\sigma_0 \sigma_1 \sigma_2$ to $\sigma_1 \sigma_2 \sigma_0$, and similarly if $j=2$ then we permute all rounds to $\sigma_2 \sigma_0 \sigma_1$. It is easy to see that the run of $\cT_i$ on the permuted input grants outputs that are permutations of the output of $\cT_0$ on the non-permuted input. 
\qed
\end{example}

\begin{example}[Round simulation is not symmetric]
\label{example:def-asymmetric}
Consider the $\sI/\sO$ transducers $\cT_1$ and $\cT_2$ over the alphabet $\sI=\{a,b\}$ and $\sO=\{0,1\}$, depicted in \autoref{fig:def-asymmetry}. 
\begin{figure}[ht]
	\centering
	\begin{tikzpicture}[shorten >=1pt,node distance=1.1cm and 2cm,on grid,auto,initial text = {}]
	\clip (-0.9,0.55) rectangle (4.5, -1.5);
	    \tikzset{every state/.style={minimum size=0pt}}
		\node[state,initial] (q_0) {$1$}; 
		\node[state] (q_b) [right=of q_0] {$0$}; 
		\node[state] (q_a) [below=of q_0] {$0$}; 
		\node[state] (q_sink) [below=of q_b] {$1$}; 
		\node[state] (q_bb) [right=of q_b] {$1$}; 
		\path[->] 
		(q_0)  edge [bend left=15] node {$b$} (q_b)
		edge [bend left=15] node {$a$} (q_a)
		(q_b)  edge [bend left=15] node {$a$} (q_0)
		edge node {$b$} (q_bb)
		(q_bb) edge node[pos=0.3] {$a,b$} (q_sink)
		(q_a)  edge node[below] {$a$} (q_sink)
		edge [bend left=15] node {$b$} (q_0)
		(q_sink) edge [loop right] node {$a,b$} ();
	\end{tikzpicture}%
	\hspace{2cm}%
	\begin{tikzpicture}[shorten >=1pt,node distance=1.1cm and 2cm,on grid,auto,initial text = {}]
	    \clip (-0.9,0.55) rectangle (4.5, -1.5);
	    \tikzset{every state/.style={minimum size=0pt}}
		\node[state,initial] (q_0) {$0$}; 
		\node[state] (q_b) [right=of q_0] {$1$}; 
		\node[state] (q_a) [below=of q_0] {$0$}; 
		\node[state] (q_sink) [below=of q_b] {$1$}; 
		\node[state] (q_bb) [right=of q_b] {$0$}; 
		\path[->] 
		(q_0)  edge [bend left=15] node {$b$} (q_b)
		edge [bend left=15] node {$a$} (q_a)
		(q_b)  edge [bend left=15] node {$a$} (q_0)
		edge node {$b$} (q_bb)
		(q_bb) edge node[pos=0.3] {$a,b$} (q_sink)
		(q_a)  edge node[below] {$a$} (q_sink)
		edge [bend left=15] node {$b$} (q_0)
		(q_sink) edge [loop right] node {$a,b$} ();
	\end{tikzpicture}%
	\caption{Transducers $\cT_1$ (left) and $\cT_2$ (right) illustrate the asymmetry in the definition of round equivalence (see \autoref{example:def-asymmetric}).}
	\label{fig:def-asymmetry}
\end{figure}
We claim that $\cT_1\prec_2 \cT_2$ but $\cT_2\not\prec_2 \cT_1$. Starting with the latter, observe that $\cT_2(ab)=00$, but $\cT_1(ab)=\cT_1(ba)=01$. Since $00\not\req[2]01$, we have $\cT_2\not\prec_2 \cT_1$. 

We turn to show that $\cT_1\prec_{2}\cT_2$.  Observe that for every input word of the form $x\in (ab+ba)^m$, we have $\cT_1(x)=(01)^m$, and $x\req[2] (ba)^m$. So in this case we have that $\cT_2((ba)^m)=(10)^m\req[2] (01)^m$. Next, for $x\in (ab+ba)^m\cdot bb\cdot w$ for some $w\in \sI^*$ we have $\cT_1(x)=(01)^m 01 1^{|w|}$ and $x\req[2] (ba)^m\cdot bb\cdot w$, for which $\cT_2((ba)^m\cdot bb\cdot w)=(01)^m 10 1^{|w|}\req[2]\cT_1(x)$.
The case where $x\in (ab+ba)^m\cdot aa\cdot w$ is handled similarly. We conclude that $\cT_1\prec_{2} \cT_2$.
\qed
\end{example}

Round simulation and round equivalence give rise to the following decision problems: 
\begin{itemize}
	\item In \emph{fixed round simulation} (resp. \emph{fixed round equivalence}) we are given transducers $\cT_1,\cT_2$, an \NFA for the language $\fL$, and $k>0$, and we need to decide whether $\cT_1\prec_{k,\fL} \cT_2$ (resp. whether $\cT_1\equiv_{k,\fL}\cT_2$).
	\item In \emph{existential round simulation} (resp. \emph{existential round equivalence}) we are given transducers $\cT_1,\cT_2$ and an \NFA for the language $\fL$, and we need to decide whether there exists $k>0$ such that $\cT_1\prec_{k,\fL} \cT_2$ (resp. $\cT_1\equiv_{k,\fL}\cT_2$). 
\end{itemize}
In the following we identify $\fL$ with an \NFA (or \DFA) for it, as we do not explicitly rely on its description.

We start by showing that deciding equivalence (both fixed and existential) is reducible, in polynomial time, to the respective simulation problem.
\begin{lemma}
	\label{lem:reduce_equiv_to_simulation}
Fixed (resp. existential) round equivalence is reducible in polynomial time to fixed (resp. existential) round simulation.
\end{lemma}
\begin{proof}
First, we can clearly reduce fixed round equivalence to fixed round simulation: given an algorithm that decides, given $\cT_1,\cT_2$, $\fL$ and $k>0$, whether $\cT_1\prec_{k,\fL} \cT_2$, we can decide whether $\cT_1\equiv_{k,\fL} \cT_2$ by using it twice to decide whether both $\cT_1\prec_{k,\fL} \cT_2$ and $\cT_1\prec_{k,\fL} \cT_2$ hold. 

A slightly more careful examination shows that the same approach can be taken to reduce existential round equivalence to existential round simulation, using the following observation: if $\cT_1\prec_{k,\fL} \cT_2$, then for every $m\in \bbN$ it holds that $\cT_1\prec_{mk,\fL}\cT_2$. Indeed, we can simply group every $m$ rounds of length $k$ and treat them as a single $mk$-round.

Now, given an algorithm that decides, given $\cT_1,\cT_2$ and $\fL$, whether there exists $k>0$ such that $\cT_1\prec_{k,\fL} \cT_2$, we can decide whether $\cT_1\equiv_{k,\fL} \cT_2$ by using the algorithm twice to decide whether there exists $k_1$ such that $\cT_1\prec_{k_1,\fL} \cT_2$ and $k_2$ such that $\cT_1\prec_{k_2,\fL} \cT_2$ hold. If there are no such $k_1,k_2$, then clearly $\cT_1 \not\equiv_{k,\fL} \cT_2$. However, if there are such $k_1,k_2$, then by the observation above we have $\cT_1\equiv_{k_1k_2,\fL}\cT_2$ (we can also take $\lcm(k_1,k_2)$ instead of $k_1k_2$).
\end{proof}
 
By \autoref{lem:reduce_equiv_to_simulation}, for the purpose of upper-bounds, we focus henceforth on round simulation.
